{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <h1>Extract Assets</h1>
    Extract various assets (textures, levels, shaders, localized strings, etc.) from an exe.
    <hr />
    <div class="card mb-3 rounded-0">
      <div class="card-header rounded-0">
        Extract Assets
      </div>
      <div class="card-body">
        The following executables have been found in your installation directory. Choose one to extract your assets from.
        <div class="mt-3">
          {% for exe in exes %}
            <div class="ml-2 form-check">
              <input class="form-check-input" type="radio" name="extract-target" id="extract-target-{{loop.index}}" value="{{exe}}">
              <label class="form-check-label" for="extract-target-{{loop.index}}">
                <code>{{exe}}</code>
              </label>
            </div>
          {% endfor %}
          <button id="extract-button" type="submit" class="mt-3 btn btn-primary" onClick="extract(event)" disabled>Extract</button>
        </div>
      </div>
      <div class="rounded-0 progress">
        <div
          id="progress-bar"
          class="rounded-0 progress-bar progress-bar-striped"
          role="progressbar"
          style="width: 0%"
        >
        </div>
      </div>
    </div>
    <ul id="alerts" class="list-unstyled">
    </ul>
  </div>
</div>
{% endblock %}

{% block script %}
<script>

let extracting = false;

document.querySelectorAll("input[name=extract-target]").forEach(elem => {
  elem.addEventListener("change", ev => {
    if (extracting) {
      return;
    }
    let extractButton = document.getElementById("extract-button");
    extractButton.disabled = false;
  });
});

function addAlert(data){
  let alerts = document.getElementById("alerts");
  let elem = document.createElement("li");
  elem.innerHTML = `
    <div class="alert alert-${data.level} alert-dismissible fade show" role="alert">
      ${data.msg}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  `;
  alerts.appendChild(elem);
}

function extractComplete(data) {
    extracting = false;
    progressBar = document.getElementById('progress-bar');
    progressBar.classList.remove("progress-bar-animated");
    progressBar.classList.remove("progress-bar-striped");

    let extractButton = document.getElementById("extract-button");
    let radioInput = document.querySelector('input[name=extract-target]:checked');
    if (radioInput) {
      extractButton.disabled = false;
    }
}

function updatePercent(percent) {
  progressBar = document.getElementById('progress-bar');
  progressBar.style.width = `${percent}%`;
  progressBar.innerHTML = `${percent}%`;
}


let ws = new WebSocket("ws://localhost:8040/ws/assets/extract/")
ws.addEventListener('message', function (event) {
    let msg = JSON.parse(event.data);
    if (msg.cmd == "extract-complete") {
      extractComplete(msg.data);
    } else if (msg.cmd == "alert") {
      addAlert(msg.data)
    } else if (msg.cmd == "extract-percent-complete") {
      updatePercent(msg.data)
    } else {
      console.log('Unexpected Message from server ', msg);
    }
});

function extract(ev) {
  let input = document.querySelector('input[name=extract-target]:checked');
  if (!input) {
    console.log("Nothing selected...");
    return;
  }

  progressBar = document.getElementById('progress-bar')
  progressBar.classList.add("progress-bar-animated")

  extracting = true;
  ev.target.disabled = true;
  ws.send(JSON.stringify({
    "cmd": "extract",
    "data": {
      "target": input.value
    }
  }));
}

</script>
{% endblock %}